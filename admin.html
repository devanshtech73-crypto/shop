<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlazeCloud Admin | Control Center</title>
    <style>
        :root { --p: #3b82f6; --bg: #020617; --g: rgba(255,255,255,0.03); --border: rgba(255,255,255,0.1); }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Inter', sans-serif; }
        body { background: var(--bg); color: #fff; overflow-x:hidden; }
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        .glass { background: var(--g); backdrop-filter: blur(15px); border: 1px solid var(--border); border-radius: 12px; }

        /* Login */
        #loginView { height: 100vh; display: flex; align-items: center; justify-content: center; background: radial-gradient(circle at top right, #1e1b4b, #020617); }
        .login-card { width: 100%; max-width: 400px; padding: 40px; }
        input { width: 100%; padding: 12px; margin: 10px 0; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 8px; color: #fff; outline: none; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-p { background: var(--p); color: #fff; width: 100%; }

        /* Dashboard */
        #dashView { display: none; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 20px; margin-bottom: 30px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; background: #4ade80; margin-right: 5px; }

        /* Forms & Tables */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .table-container { overflow-x: auto; margin-top: 30px; }
        table { width: 100%; border-collapse: collapse; text-align: left; }
        th, td { padding: 15px; border-bottom: 1px solid var(--border); }
        tr:hover { background: rgba(255,255,255,0.02); }

        /* Toasts */
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 15px 25px; border-radius: 8px; z-index: 2000; display: none; }
        
        /* Modal */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 100; }
        .modal-body { width: 100%; max-width: 500px; padding: 30px; }
    </style>
</head>
<body>

    <div id="loginView">
        <div class="login-card glass">
            <h2 style="margin-bottom:20px; text-align:center;">BlazeCloud Admin</h2>
            <input type="text" id="user" placeholder="Username">
            <input type="password" id="pass" placeholder="Password">
            <button class="btn btn-p" id="loginBtn" onclick="login()">Login to Dashboard</button>
            <p id="loginErr" style="color:#f87171; font-size:0.8rem; margin-top:10px; text-align:center;"></p>
        </div>
    </div>

    <div id="dashView" class="container">
        <div class="top-bar glass">
            <div>
                <h3 style="letter-spacing:-1px;">BLAZECLOUD ADMIN</h3>
                <span style="font-size:0.7rem; opacity:0.6;"><span class="status-dot"></span> System Operational</span>
            </div>
            <button class="btn" style="background:rgba(239,68,68,0.2); color:#f87171;" onclick="logout()">Logout</button>
        </div>

        <div class="glass" style="padding:30px;">
            <h4 style="margin-bottom:20px;">Add New Product</h4>
            <div class="form-grid">
                <input type="text" id="addName" placeholder="Product Name">
                <input type="text" id="addPrice" placeholder="Price (e.g. 299)">
                <input type="text" id="addCat" placeholder="Category">
                <div style="display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="addStock" checked style="width:auto;"> <label>In Stock</label>
                </div>
            </div>
            <button class="btn btn-p" id="addBtn" onclick="addProduct()">Create Product</button>
        </div>

        <div class="table-container glass">
            <table>
                <thead>
                    <tr><th>Name</th><th>Category</th><th>Price</th><th>Stock</th><th>Actions</th></tr>
                </thead>
                <tbody id="productTable"></tbody>
            </table>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-body glass">
            <h3>Edit Product</h3>
            <input type="hidden" id="editId">
            <input type="text" id="editName" placeholder="Name">
            <input type="text" id="editPrice" placeholder="Price">
            <input type="text" id="editCat" placeholder="Category">
            <div style="margin: 10px 0;">
                <input type="checkbox" id="editStock" style="width:auto;"> In Stock
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-p" onclick="saveEdit()">Update</button>
                <button class="btn" style="background:#334155;" onclick="closeEdit()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast glass"></div>

    <script>
        const API_BASE = "https://YOUR-RAILWAY-URL"; // REPLACE THIS
        let currentToken = localStorage.getItem('blaze_token');

        // Check Auth on load
        if(currentToken) showDash();

        async function apiFetch(endpoint, options = {}) {
            const headers = { 'Content-Type': 'application/json' };
            if(currentToken) headers['Authorization'] = `Bearer ${currentToken}`;
            
            const res = await fetch(`${API_BASE}${endpoint}`, { ...options, headers });
            
            if(res.status === 401 || res.status === 403) {
                logout();
                throw new Error("Session expired. Please login again.");
            }
            return res;
        }

        async function login() {
            const btn = document.getElementById('loginBtn');
            btn.disabled = true; btn.innerText = "Authenticating...";
            try {
                const res = await fetch(`${API_BASE}/api/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username: document.getElementById('user').value,
                        password: document.getElementById('pass').value 
                    })
                });
                const data = await res.json();
                if(!res.ok) throw new Error(data.message || "Login failed");
                
                currentToken = data.token;
                localStorage.setItem('blaze_token', currentToken);
                showDash();
                showToast("Welcome back, Admin!", "success");
            } catch(err) {
                document.getElementById('loginErr').innerText = err.message;
            } finally {
                btn.disabled = false; btn.innerText = "Login to Dashboard";
            }
        }

        function showDash() {
            document.getElementById('loginView').style.display = 'none';
            document.getElementById('dashView').style.display = 'block';
            loadProducts();
        }

        function logout() {
            localStorage.removeItem('blaze_token');
            location.reload();
        }

        async function loadProducts() {
            try {
                const res = await apiFetch('/api/products');
                const products = await res.json();
                renderTable(products);
            } catch(err) { showToast(err.message, "error"); }
        }

        function renderTable(list) {
            const body = document.getElementById('productTable');
            body.innerHTML = list.map(p => `
                <tr>
                    <td>${p.name}</td>
                    <td>${p.category}</td>
                    <td>â‚¹${p.price}</td>
                    <td><span style="color:${p.stockStatus ? '#4ade80' : '#f87171'}">${p.stockStatus ? 'Yes' : 'No'}</span></td>
                    <td>
                        <button class="btn" style="background:rgba(59,130,246,0.1); color:#60a5fa; padding:5px 10px; margin-right:5px;" onclick='openEdit(${JSON.stringify(p)})'>Edit</button>
                        <button class="btn" style="background:rgba(239,68,68,0.1); color:#f87171; padding:5px 10px;" onclick="deleteProduct('${p._id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        async function addProduct() {
            const btn = document.getElementById('addBtn');
            const body = {
                name: document.getElementById('addName').value,
                price: document.getElementById('addPrice').value,
                category: document.getElementById('addCat').value,
                stockStatus: document.getElementById('addStock').checked
            };
            
            btn.disabled = true;
            try {
                await apiFetch('/api/products', { method: 'POST', body: JSON.stringify(body) });
                showToast("Product created successfully!");
                loadProducts();
                ['addName', 'addPrice', 'addCat'].forEach(id => document.getElementById(id).value = '');
            } catch(err) { showToast(err.message, "error"); }
            finally { btn.disabled = false; }
        }

        function openEdit(p) {
            document.getElementById('editId').value = p._id;
            document.getElementById('editName').value = p.name;
            document.getElementById('editPrice').value = p.price;
            document.getElementById('editCat').value = p.category;
            document.getElementById('editStock').checked = p.stockStatus;
            document.getElementById('editModal').style.display = 'flex';
        }

        async function saveEdit() {
            const id = document.getElementById('editId').value;
            const body = {
                name: document.getElementById('editName').value,
                price: document.getElementById('editPrice').value,
                category: document.getElementById('editCat').value,
                stockStatus: document.getElementById('editStock').checked
            };
            try {
                await apiFetch(`/api/products/${id}`, { method: 'PUT', body: JSON.stringify(body) });
                showToast("Product updated!");
                closeEdit();
                loadProducts();
            } catch(err) { showToast(err.message, "error"); }
        }

        async function deleteProduct(id) {
            if(!confirm("Are you sure you want to delete this product?")) return;
            try {
                await apiFetch(`/api/products/${id}`, { method: 'DELETE' });
                showToast("Product removed.");
                loadProducts();
            } catch(err) { showToast(err.message, "error"); }
        }

        function closeEdit() { document.getElementById('editModal').style.display = 'none'; }

        function showToast(msg, type = "success") {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            t.style.borderLeft = `4px solid ${type === 'success' ? '#4ade80' : '#f87171'}`;
            setTimeout(() => t.style.display = 'none', 3000);
        }
    </script>
</body>
</html>
